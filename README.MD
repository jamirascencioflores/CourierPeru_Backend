## üöÄ Gu√≠a de Integraci√≥n: Frontend Angular + Microservicios (JWT)
Hola compa√±ero, el Backend ya est√° operativo bajo una arquitectura de microservicios protegida. Para que el Frontend pueda comunicarse correctamente, debemos seguir estos est√°ndares de seguridad y conectividad.

### 1. Datos de Conexi√≥n (Endpoint √önico)
   No debes llamar a cada microservicio por separado. Todo debe pasar por el API Gateway, que act√∫a como √∫nico punto de entrada.

- **Base URL**: ```http://localhost:8080```

- **Rutas de Autenticaci√≥n**: ```/auth/login``` y ```/auth/register```

- **Rutas de Negocio (Protegidas)**: ```/api/orders/**```, ```/api/shipping/**```, ```/api/notifications/**```

### 2. Flujo de Autenticaci√≥n con JWT
- **Login**: Haz un POST a ```http://localhost:8080/auth/login``` enviando ```userName``` y ```password```.

- **Almacenamiento**: El backend responder√° con una cadena de texto (el Token). Gu√°rdalo en el ```localStorage```.

- **Seguridad**: Para cualquier petici√≥n a las rutas /api/**, el Gateway rechazar√° la entrada si no incluyes el header:
Authorization: Bearer <tu_token_aqu√≠>

### 3. Implementaci√≥n del Interceptor (CRUCIAL)
   En Angular, no a√±adas el token manualmente en cada servicio. Crea un **HttpInterceptor** para automatizar el proceso. Este interceptor a√±ade el token a las cabeceras y maneja errores de sesi√≥n expirada (401).

**C√≥digo del Interceptor** ```auth.interceptor.ts)```:

```
import { Injectable } from '@angular/core';
import { HttpRequest, HttpHandler, HttpEvent, HttpInterceptor, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { Router } from '@angular/router';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {

constructor(private router: Router) {}

intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
const token = localStorage.getItem('token');

    // 1. Clonar la petici√≥n e inyectar el token si existe
    if (token) {
      request = request.clone({
        setHeaders: {
          Authorization: `Bearer ${token}`
        }
      });
    }

    // 2. Manejar la respuesta y capturar errores 401 (Unauthorized)
    return next.handle(request).pipe(
      catchError((error: HttpErrorResponse) => {
        if (error.status === 401) {
          // Si el token expir√≥ o es inv√°lido, limpiamos y redirigimos al login
          localStorage.removeItem('token');
          this.router.navigate(['/login']);
        }
        return throwError(() => error);
      })
    );
}
}
```

### 4. Estructura de Servicios Sugerida
   Para mantener el proyecto escalable, crea un servicio por dominio:

- ```AuthService```: Maneja ```login()```, ```register()``` y el estado de la sesi√≥n.

- ```OrderService```: Peticiones a ```/api/orders```.

- ```ShippingService```: Peticiones a ```/api/shipping/calculate?peso=X```.

### 5. Modelos de Datos (DTOs)
   Para el registro de usuario, el objeto JSON debe ser:

```
{
"userName": "ejemplo",
"password": "123",
"email": "correo@test.com",
"role": "USER"
}
```

### 6. Consideraci√≥n de CORS
   El Gateway ya est√° configurado para permitir peticiones desde ```http://localhost:4200``` (puerto por defecto de Angular). Si decides usar otro puerto, av√≠same para actualizar la lista blanca en el Backend.

### 7. üóÑÔ∏è Configuraci√≥n de la Base de Datos (PostgreSQL)
El proyecto utiliza **PostgreSQL** como motor de base de datos. Cada microservicio apunta a una base de datos espec√≠fica para mantener el aislamiento de datos (Arquitectura de Microservicios).

### a. Scripts de Creaci√≥n
   Ejecuta los siguientes comandos en tu terminal de PostgreSQL o en tu herramienta de gesti√≥n (pgAdmin / DBeaver):

```
-- Crear la base de datos para el microservicio de Autenticaci√≥n
CREATE DATABASE db_auth;

-- Crear la base de datos para el microservicio de √ìrdenes
CREATE DATABASE db_orders;

-- Crear la base de datos para el microservicio de Env√≠os
CREATE DATABASE db_shipping;
```

### b. Configuraci√≥n de Conexi√≥n
   Aseg√∫rate de que el archivo src/main/resources/application.yml de cada microservicio tenga las credenciales correctas. Ejemplo para ms-auth:


```
spring:
datasource:
url: jdbc:postgresql://localhost:5432/db_auth
username: tu_usuario_postgres
password: tu_password_postgres
driver-class-name: org.postgresql.Driver
jpa:
hibernate:
ddl-auto: update # Crea las tablas autom√°ticamente al iniciar
show-sql: true
```
---


## üì® Configuraci√≥n de Mensajer√≠a (RabbitMQ)
El sistema utiliza **RabbitMQ** para la comunicaci√≥n as√≠ncrona entre el microservicio de √≥rdenes (``ms-orders``) y el de notificaciones (``ms-notifications``).
### 1. Requisitos de Instalaci√≥n
Es necesario tener instalado RabbitMQ y Erlang en tu m√°quina local.
- **Host**: localhost
- **Puerto**: 5672
- **Panel de Administraci√≥n**: ``http://localhost:15672`` (Usuario/Password por defecto: ``guest``/``guest``)

### 2. Infraestructura de Mensajer√≠a
Spring Boot crear√° autom√°ticamente los componentes necesarios al iniciar los servicios. La configuraci√≥n l√≥gica es la siguiente:
- **Exchange**: ``correo.exchange`` (Tipo: Direct)
- **Queue**: ``cola.correos``
- **Routing Key**: ``envio.correo``

### 3. Configuraci√≥n en application.yml
Todos los microservicios que utilicen mensajer√≠a deben tener el siguiente bloque de configuraci√≥n:
```
spring:
rabbitmq:
host: localhost
port: 5672
username: guest
password: guest
```
---

### üõ†Ô∏è Gu√≠a de Ejecuci√≥n del Proyecto (Orden Sugerido)
Para que el ecosistema de microservicios arranque sin errores, sigue este orden:
1. Infraestructura Base: Inicia PostgreSQL y RabbitMQ.
2. Service Discovery: Inicia ``eureka-server`` (Puerto 8761).
3. Configuraci√≥n de Seguridad: Inicia ``ms-auth``.
4. Puerta de Enlace: Inicia ``api-gateway`` (Puerto 8080).
5. Servicios de Negocio: Inicia ``ms-orders``, ``ms-shipping`` y ``ms-notifications``.
---

## üìã Resumen de Puertos

| Servicio           | Puerto | Descripci√≥n                                  |
|--------------------|--------|----------------------------------------------|
| ``eureka-server  ``    | 8761   | Dashboard de Microservicios                  |
| ``api-gateway``        | 8080   | **Punto de entrada √∫nico (CORS habilitado)** |
| ``ms-auth ``           | 8089   | Gesti√≥n de JWT y Usuarios                    |
| ``ms-orders``          | 8081   | L√≥gica de pedidos                            |
| ``ms-shipping``        | 8082   | C√°lculo de tarifas de env√≠o                  |
| ``ms-notifications ``  | 8083   | Worker de env√≠o de correos                   |

